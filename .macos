#!/usr/bin/env bash

# include colorized echo
source ./bin/echos.sh
# Start
bot "Starting $(basename "$0")"

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `.macos` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

########################################    #######################################
# General System
###############################################################################
running "Set computer name (as done via System Preferences → Sharing)"
read -r -p "Please enter new hostname _: " _hn

sudo scutil --set ComputerName "$_hn"
sudo scutil --set HostName "$_hn"
sudo scutil --set LocalHostName "$_hn"
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string "$_hn"
ok

running "Disable the sound effects on boot.  To re-enable: sudo nvram -d SystemAudioVolume"
sudo nvram SystemAudioVolume="%80"
ok



# Enable verbose booting.  To reset to default: sudo nvram boot-args="" ; sudo nvram -d boot-args
#sudo nvram boot-args="-v"

###############################################################################
# General UI/UX
###############################################################################


# Expand save panel by default
# defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true

running "Check for software updates daily, not just once per week"
defaults write com.apple.SoftwareUpdate ScheduleFrequency -int 1
ok

running "Remove duplicates in the 'Open With' menu"
/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -kill -r -domain local -domain system -domain user
ok

###############################################################################
# Trackpad, keyboard
###############################################################################

running "Trackpad: enable tap to click"
defaults -currentHost write NSGlobalDomain "com.apple.mouse.tapBehavior" -int 1
ok

running "Trackpad: disable look up"
defaults -currentHost write NSGlobalDomain "com.apple.trackpad.threeFingerTapGesture" -int 0
ok

running "Trackpad: enable 3 finger drag"
defaults -currentHost write NSGlobalDomain "com.apple.trackpad.threeFingerDragGesture" -int 1
ok

running "Trackpad: disable swipe between pages"
defaults write NSGlobalDomain AppleEnableSwipeNavigateWithScrolls -bool false
ok

running "Keyboard: enable full keyboard access for all controls, (e.g. enable Tab in modal dialogs)"
defaults write NSGlobalDomain AppleKeyboardUIMode -int 2
ok

running "Keyboard: Disable auto-correct"
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false
ok

###############################################################################
# Screen
###############################################################################

# Require password immediately after sleep or screen saver begins
# Commented due to overwriting by work policies
# defaults write com.apple.screensaver askForPassword -int 1
# defaults write com.apple.screensaver askForPasswordDelay -int 0

running "Save screenshots to the Pictures directory"
defaults write com.apple.screencapture location -string "${HOME}/Pictures"
ok

running "Save screenshots in PNG format"
defaults write com.apple.screencapture type -string "png"
ok # (other options: BMP, GIF, JPG, PDF, TIFF)

running "Disable shadow in screenshots"
defaults write com.apple.screencapture disable-shadow -bool true
ok

###############################################################################
# Finder
###############################################################################

running "Icons for hard drives, servers, and removable media on the desktop"
defaults write com.apple.finder ShowExternalHardDrivesOnDesktop -bool false
defaults write com.apple.finder ShowHardDrivesOnDesktop -bool false
defaults write com.apple.finder ShowMountedServersOnDesktop -bool false
defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool false
ok

running "Finder: show hidden files by default"
defaults write com.apple.finder AppleShowAllFiles -bool true
ok

running "Finder: keep folders on top when sorting by name"
defaults write com.apple.finder _FXSortFoldersFirst -bool true
ok

running "Finder: show full path in title"
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true
ok

running "Finder: show status bar"
defaults write com.apple.finder ShowStatusBar -bool true
ok

running "Finder: show path bar"
defaults write com.apple.finder ShowPathbar -bool true
ok

running "Finder: when performing a search, search the current folder by default"
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
ok

running "Finder: use list view in all Finder windows by default"
# Four-letter codes for the other view modes: `icnv`, `clmv`, `Flwv`
defaults write com.apple.finder FXPreferredViewStyle -string "clmv"
ok

running "Finder: show all filename extensions"
defaults write NSGlobalDomain AppleShowAllExtensions -bool true
ok

running "Avoid creating .DS_Store files on network volumes"
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
ok

running "Avoid creating .DS_Store files on USB Volumes"
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true
ok

running "Show the ~/Library folder"
chflags nohidden "$HOME/Library"
ok

running "Expand save panel by default"
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
ok

running "Sets default save target to be a local disk, not iCloud."
defaults write NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false
ok

running "Disable the 'Are you sure you want to open this application?' dialog"
defaults write com.apple.LaunchServices LSQuarantine -bool false
ok

running "Show battery percent"
defaults write com.apple.menuextra.battery ShowPercent -bool true
ok

###############################################################################
# Dock, Dashboard, and hot corners
###############################################################################

running "Dock: minimise and maximise effect set to 'scale'"
# Possible settings: genie, scale
defaults write com.apple.dock mineffect -string "scale"
ok

# Show indicator lights for open applications in the Dock
# defaults write com.apple.dock show-process-indicators -bool true

# Don’t animate opening applications from the Dock
# defaults write com.apple.dock launchanim -bool true

# Speed up Mission Control animations
# defaults write com.apple.dock expose-animation-duration -float 0.1

running "Don’t show Dashboard as a Space"
defaults write com.apple.dock dashboard-in-overlay -bool true
ok

running "Don’t automatically rearrange Spaces based on most recent use"
defaults write com.apple.dock mru-spaces -bool false
ok

# Remove the animation when hiding/showing the Dock
# defaults write com.apple.dock autohide-time-modifier -int 0

# Minimise applications to their icon
# defaults write com.apple.dock "minimize-to-application" -bool true

running "Top right screen corner → Put display to sleep"
# Hot corners:
# Possible values:
#  0: no-op
#  2: Mission Control
#  3: Show application windows
#  4: Desktop
#  5: Start screen saver
#  6: Disable screen saver
#  7: Dashboard
# 10: Put display to sleep
# 11: Launchpad
# 12: Notification Center
defaults write com.apple.dock wvous-tr-corner -int 5
defaults write com.apple.dock wvous-tr-modifier -int 0
ok


###############################################################################
# Address Book, Dashboard, iCal, TextEdit, and Disk Utility                   #
###############################################################################

running "Start week on Monday"
defaults write com.apple.ical "first day of the week" 1
ok

###############################################################################
# Photos                                                                      #
###############################################################################

running "Prevent Photos from opening automatically when devices are plugged in"
defaults -currentHost write com.apple.ImageCapture disableHotPlug -bool true
ok

###############################################################################
# Energy preferences
###############################################################################

# battery
# sudo pmset -b sleep 20 disksleep 15 displaysleep 10 halfdim 1

# power adapter
# sudo pmset -c sleep 0 disksleep 0 displaysleep 10 halfdim 1

###############################################################################
# Firewall
###############################################################################

running "Enable the firewall"
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
ok

# Do not auto allow signed apps
# sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setallowsigned off

running "Enable stealth mode"
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setstealthmode on
ok

###############################################################################
# Mail
###############################################################################

# Disable send and reply animations in Mail.app
# defaults write com.apple.mail DisableReplyAnimations -bool true
# defaults write com.apple.mail DisableSendAnimations -bool true

running "Mail.app: copy email addresses as \`foo@example.com\` instead of \`Foo Bar <foo@example.com>\`"
defaults write com.apple.mail AddressesIncludeNameOnPasteboard -bool false
ok

# Display emails in threaded mode, sorted by date (oldest at the top)
# defaults write com.apple.mail DraftsViewerAttributes -dict-add "DisplayInThreadedMode" -string "yes"
# defaults write com.apple.mail DraftsViewerAttributes -dict-add "SortedDescending" -string "yes"
# defaults write com.apple.mail DraftsViewerAttributes -dict-add "SortOrder" -string "received-date"

# Default sort order
# defaults write com.apple.mail InboxViewerAttributes -dict-add "SortedDescending" -string "yes"

running "Mail.app: Disable inline attachments (just show the icons)"
defaults write com.apple.mail DisableInlineAttachmentViewing -bool true
ok

running "Mail.app: Insert attachments at end of message (stops exchange servers adding ATT00001.htm etc. to your emails)"
defaults write com.apple.mail AttachAtEnd -bool true
ok

###############################################################################
# Safari & WebKit
###############################################################################

# Set Safari’s home page to `about:blank` for faster loading
# defaults write com.apple.Safari HomePage -string "about:blank"
# defaults write com.apple.Safari NewTabBehavior -int 0
# defaults write com.apple.Safari NewWindowBehavior -int 0

running "Safari: prevent Safari from opening ‘safe’ files automatically after downloading"
defaults write com.apple.Safari AutoOpenSafeDownloads -bool false
ok

# Allow hitting the Backspace key to go to the previous page in history
# defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2BackspaceKeyNavigationEnabled -bool true

# Hide Safari’s bookmarks bar by default
# defaults write com.apple.Safari ShowFavoritesBar -bool false

running "Safari: Disable Safari’s thumbnail cache for History and Top Sites"
defaults write com.apple.Safari DebugSnapshotsUpdatePolicy -int 2
ok

running "Safari: Enable Safari’s debug menu"
defaults write com.apple.Safari IncludeInternalDebugMenu -bool true
ok

# Make Safari’s search banners default to Contains instead of Starts With
# defaults write com.apple.Safari FindOnPageMatchesWordStartsOnly -bool false

running "Safari: Stop Safari sending searches to Apple"
defaults write com.apple.Safari UniversalSearchEnabled -bool false
ok

###############################################################################
# TextEdit
###############################################################################

running "TexEdit: Use plain text mode for new TextEdit documents"
defaults write com.apple.TextEdit RichText -int 0
ok

running "TexEdit: Open and save files as UTF-8 in TextEdit"
defaults write com.apple.TextEdit PlainTextEncoding -int 4
defaults write com.apple.TextEdit PlainTextEncodingForWrite -int 4
ok



# Finished
bot "$(basename "$0") complete. Note that some of these changes require a logout/restart to take effect."
